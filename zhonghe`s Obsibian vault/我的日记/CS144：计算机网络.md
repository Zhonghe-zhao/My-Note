
## 开始

http get command 浏览器和服务器建立连接 

服务器很少位于NAT之后 因为 互联网的任何人都可以访问它，个人电脑 一般位于NAT之后 

*万维网*

*bitTorrent*  双向字节字符串 

*skype*：

NAT 网路地址转换 

![[NAT.png]]


b 向计算计发送一条信息 表示b已经连接到该计算机  b打开了a的连接 ： 

***反向连接：*** 原本是a呼叫b打开b的连接，但是最终结果是b打开了a的连接 

**1. 问题：这个是a不在NAT之后 如果两个都位于NAT之后如何通信呢？**

第二种服务器 中继：relay

![[中继服务器.png]]


## 四层模型：

作用： 应用程序能够与终端主机进行可靠通信

数据以数据包的形式传输

#### Link： 链路层

链路层的主要任务是确保数据在物理介质上的可靠传输。

*以太网和WiFi* ：

1. 以太网：

- MAC 地址：每个设备都有一个唯一的 MAC 地址，用于标识网络中的设备。

- 广泛应用于局域网（LAN）中。 

***它提供了计算机和其他设备在局部区域内进行数据交换的方式***

- **物理介质**：以太网可以通过双绞线（如 Cat5e、Cat6）、光纤或无线（如 Wi-Fi）传输数据。

2. WiFi :

- Wi-Fi 是一种无线链路层技术，广泛应用于无线局域网（WLAN）中。
- MAC 地址：与以太网类似，Wi-Fi 设备也有唯一的 MAC 地址。
- 数据帧格式：Wi-Fi 使用特定的帧格式来封装数据，包括控制字段、地址字段和数据字段。

 **当手机向笔记本电脑发送数据时，链路层会将数据封装为 Wi-Fi 帧，并通过无线信道传输。**


#### Network: 网络层

通过互联网 端到端的 从 源到目的地传递数据包 是网络中的重要组成部分

网络层数据包：称为 **数据报**：

**报头（Header）** ：  源 IP 地址  目标 IP 地址 等
    


**数据部分（Payload）**： 包含上层协议（如 TCP、UDP）传递的数据。


***网络层将数据报交给链路层  向下传递***

![[数据报传输.png]]


另一方面 ***路由器*** 从*链路层接收数据包*并将其转交给*路由器内的网络层*

![[传输.png]]

####  ip 

尽力 将数据报传送到另一端 但是 ip 可能会无序传送并且可能损坏

所以需要在ip之上运行另一个协议  转移到

#### ***Transport 传输层***

**TCP协议**：TCP协议确保数据传输的可靠性。

**UDP协议**： 不提供任何传送保证


#### Application 应用层

应用程序 在两个端点之间 建立 双向可靠的字节流

![[总体路线.png]]

1. 向下选择 是否可靠传输-》数据包-》 链路层-》 传输-》 重新封装


***ip is the "thin waist"***

这句话强调了 IP 协议在互联网架构中的核心地位。它像沙漏的细腰一样，连接了上层的多样性和下层的多样性，实现了互联网的灵活性和可扩展性。这种设计是互联网成功的关键之一，但也带来了一些挑战，需要在未来的发展中不断改进。


---

## 网络层

IP Datagram -》 IP Data + IP Hdr  

数据报中包含 源地址和目的地址

路由器根据*转发表* 对照地址 一步步向下传递

类比 快递 一站一站传递 但是他不保证我们什么时候才能被送到

ip 丢包了也不会告诉原数据包 

ip不可靠 丢包 错误的路由表会导致到错误的目的地  或者导致数据包被错误的复制

ip是非常简单的最小服务 通信无连接 

#### 问题1：

ip的主要作用是什么？ 为什么ip要有发送数据包到目的地的能力呢？ 而且它的传递还是不可靠的

#### 回答1:

1.  **IP的主要作用**
#### **寻址（Addressing）**

IP为网络中的每个设备分配唯一的逻辑地址（IP地址），用于标识发送方和接收方

2.  **路由（Routing）**

- IP协议定义了数据包如何通过多个网络节点（如路由器）从源地址跳转到目标地址。
    
- 路由器根据IP地址和路由表决定数据包的下一跳路径。

 3. **分片与重组（Fragmentation & Reassembly）**

- 如果数据包大小超过底层网络（如以太网）的最大传输单元（MTU），IP会将其分片传输，并在目的地重组。


IP的核心设计目标是**实现跨网络的通信**，无论底层网络技术（以太网、Wi-Fi、光纤等）如何差异。它的存在解决了以下问题：

- **异构网络互联**：不同物理网络（如局域网和广域网）可能使用不同的寻址方式（如MAC地址），IP通过统一的逻辑地址（IP地址）屏蔽底层差异，实现互联。

***IP协议本身不保证数据包的可靠传输，这是其设计上的刻意选择，原因包括：***

- IP是网络层协议，专注于高效的路由和寻址。可靠性（如丢包重传、顺序纠正）由更高层协议（如TCP）负责。

这种分层设计使得IP轻量化，适应不同应用需求 ， 例如视频流可以容忍丢包，但文件传输需要可靠性
*IP的“不可靠”允许上层协议（如TCP或UDP）根据需求自行处理*

维护成本更低 数据包也会更快的到达 专门硬件加速 

***端到端原则：***

其核心观点是：


> **“某些功能（如可靠性、安全性）最好在通信的最终端点（end hosts）实现，而不是在网络中间节点（如路由器、交换机）上实现。”**

 ip可以让应用程序选择 使用可靠还是不可靠 

#### 为什么 ip服务如此简单？

![[ip server is so simple.png]]


i![[IP Model.png]]

#### 了解ipv4每个字段的作用


![[ipv4.png]]


---

环境配置

直接使用wsl



```c
root@xiaoxinxiaohao:/CS144# 

telnet cs144.keithw.org http

Trying 104.196.238.229...
Connected to cs144.keithw.org.
Escape character is '^]'.

GET /hello HTTP/1.1
Host: cs144.keithw.org
Connection: close

HTTP/1.1 200 OK
Date: Sat, 15 Mar 2025 11:32:33 GMT
Server: Apache
Last-Modified: Thu, 13 Dec 2018 15:45:29 GMT
ETag: "e-57ce93446cb64"
Accept-Ranges: bytes
Content-Length: 14
Connection: close
Content-Type: text/plain

Hello, CS144!
Connection closed by foreign host.

```



~~~
1. **获取邮箱的 SMTP 服务器地址**：
    
    - 不同邮箱提供商的 SMTP 服务器地址不同。以下是一些常见邮箱的 SMTP 服务器：
        
        - Gmail: `smtp.gmail.com`（端口 587 或 465）
            
        - Outlook/Hotmail: `smtp.office365.com`（端口 587）
            
        - Yahoo: `smtp.mail.yahoo.com`（端口 465 或 587）
            
        - QQ 邮箱: `smtp.qq.com`（端口 465 或 587）
~~~


![[telnet.png]]


 netcat -v -l -p 9090（服务器）
 telnet localhost 9090 (客户端)


 #### *通信服务是无连接的*

**通信双方在传输数据前不需要预先建立专用连接，每个数据包（或数据报）独立传输，彼此没有依赖关系**。

 **无需预先建立连接**

- 在发送数据前，发送方和接收方**不需要握手（如TCP的三次握手）**，直接发送数据包。
    
- 例如：IP协议发送数据包时，不会先询问对方是否准备好，而是直接发出。

 **每个数据包独立处理**

- 每个数据包（如IP数据报或UDP报文）**单独寻址和路由**，即使属于同一个通信流，也可能走不同路径。
    
- 例如：发送3个数据包，可能走不同的网络路径，到达顺序也可能不同。

**不维护连接状态**

- 通信双方**不会记录对方的状态**（如TCP的序列号、窗口大小等）。
    
- 例如：IP路由器转发数据包后，不会记住这个包是谁发的，也不会确保它一定能到达。

 **不可靠性（通常）**

- 无连接协议通常不保证数据包一定能到达、按序到达或不重复（如IP和UDP）。
    
- 可靠性（如丢包重传）需要由上层协议（如TCP）或应用程序自己处理。


***省去握手过程（如TCP三次握手），减少延迟***


#### 三次握手

同步 同步 确认

  



---

#### TCP Byte Stream

*互联网协议地址*： 网络层 用来将数据包传递到计算机的地址

*TCP端口*：计算机软件将数据传递到哪个应用程序 


#### 路由器 

通过路由器相连 IP数据包 经过多次跳跃 *跳跃*是连接两个路由器的*链路*

路由器会决定将数据包发送到哪个链路！


如果我是用TCP登录路由器 IP数据包的目标是路由器自己的IP！

**路由器如何做到上述决策？**

**转发表（Routing Table）** ：

是*路由器*或*主机*用于*决定网络数据包*转发*路径*的数据结构。

路由器检查哪个转发表条目的模式最匹配该数据包

简化：

|目标网络|子网掩码|下一跳|接口|优先级|
|---|---|---|---|---|

|   |   |   |   |   |
|---|---|---|---|---|
|0.0.0.0|0.0.0.0|192.168.1.1|eth0|10|

|             |               |         |      |     |
| ----------- | ------------- | ------- | ---- | --- |
| 192.168.1.0 | 255.255.255.0 | 0.0.0.0 | eth0 | 0   |

 ***应用技巧：***

- 后端部署多服务时，合理配置路由可以**隔离内外流量**
    
- 多网卡时，不正确的转发表配置可能导致服务“能 ping 通但连不上”

#### 工具

##### wireshark的使用：

![[抓包分析.png]]


***左下角对应的是网络协议的几个分层***

***右下角对应的是 左侧 16进制 右侧ASCII***

*过滤器的使用：*

显示过滤器 ：

过滤以捕获的数据包
符合条件的进行筛选


捕获过滤器：

只捕获符合条件的数据包


#### 问题：

为什么f12抓取的页面 远程网址都导向了127.0.0.1

~~~
请求 URL:

https://cm.bilibili.com/cm/api/fees/pc

请求方法:

POST

状态代码:

200 OK

远程地址:

127.0.0.1:7890

引用站点策略:

no-referrer-when-downgrade
~~~

#### 解答：

本机的请求**被代理到了本地的一个代理服务上**（一般是你的代理工具，比如 Clash、V2Ray、Shadowrocket、Surge 等），7890 是它默认监听的端口之一。

***关闭代理之后 抓取就正常了 这其中一定有什么奥秘！*** 带解答！！！！！


![[捕获器.png]]

#### 筛选条件 

`(ip.addr == 218.60.18.15 && tcp.port == 80 && ) && (_ws.col.info == "443 → 58972 [ACK] Seq=1 Ack=1201 Win=42496 Len=0")`  
再info中可以右键且选中使用内容作为过滤条件

#### ARP协议

交换MAC地址与IP地址关系的协议

- **相互配合实现通信**：在进行网络通信时，*IP 地址和 MAC 地址相互协作*。当一台设备要向另一台设备发送数据时，*首先*会根据目标设备的 *IP 地址*，通过*网络层*的*路由协议*确定数据传输的*路径*；当数据到达*目标设备所在的局域网*后，就需要通过 *MAC 地址来完成最后的数据传输*，将数据准确无误地发送到目标设备。

- **ARP 协议建立映射**：*ARP*（Address Resolution Protocol）协议的作用是将 *IP 地址*解析为对应的 *MAC 地址*。当设备需要和目标设备通信时，它会先在*本地的 ARP 缓存表*中查找*目标 IP 地址*对应的 *MAC 地址*。如果找不到，就会发送一个 *ARP 请求广播*，*询问局域网*内拥有该 I*P 地址的设备的 MAC 地址*。拥有该 IP 地址的设备会*回应一个 ARP 响应*，告知*自己的 MAC 地址*。这样，发送设备就能够建立起目标 *IP 地址和 MAC 地址的映射关系，进而进行数据传输。*

![[ARP协议.png]]

![[ARP互相应答.png]]

~~~
Target MAC address: TpLinkTechno_8f:8c:fd (64:6e:97:8f:8c:fd) 

这是 其中一个询问的 

Sender MAC address: TpLinkTechno_8f:8c:fd (64:6e:97:8f:8c:fd) 

这个是回复的 ，

我想在电脑上用什么命令查看 是否验证一下哪个是我的设备
~~~

![[我的网卡名称.png]]


**说明 CloudNetwork回复了发问的这个人**

过滤添加 *dns* ： 因为dns是明文传输，所以访问哪个网站 都可以通过dns看到 

例如：： qq.com 

所以通过*加密DNS* 和 *https*加密 就可以避免让黑客得知这串消息

![[编辑DNS.png]]

配置加密之后， 使用wireshark过滤

*ip.addr == 223.5.5.5*

显示的信息都是被加密之后的信息

添加了 *SSLKEYLOGFILE* 密钥解密TCP 使咱们可以观察到http等 get 请求 否则如果使https的加密网站咱们什么都观察不到



##### tracerout：

显示了包到达目标的跳跃路径

traceroute_命令在Windows中的等效命令是 _tracert

![[traceout.png]]


#### 分组交换

它的核心思想是：**将数据拆分成多个小数据块（分组/Packet），独立传输，并在目的地重新组装**

一个**数据包**： 包含自身数据 携带到达目的地所需要的信息

分组交换不需要独占通信链路，而是共享网络资源，从而大幅提高效率。

 **1.分组交换的核心思想：**
 
 **数据分块（Packetization）**
 
- 发送方将完整的数据（如文件、视频、网页请求）拆分成多个**固定或可变大小的分组**。
    
- 每个分组包含：
    
    - **首部（Header）**：源/目标地址、序号、校验和等控制信息。
        
    - **数据部分（Payload）**：实际传输的数据片段。
        
    - **尾部（Trailer，可选）**：错误检测码（如CRC）。

 **独立路由（Independent Routing）**

- 分组通过网络中的**路由器（Router）**逐跳（Hop-by-Hop）转发。
    
- **每个分组可能走不同的路径**（动态路由），最终在目的地按序号重组。


 **统计复用（Statistical Multiplexing）**

- 链路资源被所有分组**共享**，而非独占。
    
- 当网络空闲时，分组可以快速传输；当拥塞时，分组可能需要排队等待。


交换机保存着 每个数据包要发送的下一跳路由，或者交换机自己决策将数据包发送到下一跳！

**交换机**不需要关心什么 只需要将数据包发送！ 

**交换机*核心关注： 快速有效的转发数据包***


 **1. 交换机与路由器的区别核心区别**

|**特性**|**交换机（Switch）**|**路由器（Router）**|
|---|---|---|
|**工作层次**|**数据链路层（Layer 2）**|**网络层（Layer 3）**|
|**主要功能**|基于MAC地址转发数据帧|基于IP地址转发数据包|
|**寻址方式**|使用MAC地址（如 `00:1A:2B:3C:4D`）|使用IP地址（如 `192.168.1.1`）|
|**连接范围**|同一局域网（LAN）内设备互联|不同网络之间互联（如LAN到WAN）|
|**典型应用**|企业内网、家庭局域网|连接家庭网络到互联网（ISP）|



##### 如何有效共享链路！



数据包序列称为*流*是属于同一个端到通信的一组*数据报*

##### 问题：

**每个数据包的独立路由**  怎么理解？

##### 问题：

怎么理解 每个数据包是自包含的 所以交换机不需要直到数据包组或流


### **为什么交换机不需要知道“组”或“流”？**

- **交换机的工作层次**（数据链路层，Layer 2）：
    
    - 交换机**只认MAC地址**，不解析IP或更高层协议（如TCP流）。
        
    - 它通过**MAC地址表**决定将数据帧转发到哪个端口，完全**不关心**：
        
        - 这个包属于哪个TCP连接。
            
        - 前后包是否有逻辑关联。


***交互机需要知道如何清除故障节点*** ！！

如果你请求浏览器，但是出于某种原因 你的电脑关机了！

~~~
**高级交换机的状态保留（需要特别注意）**：

- **三层交换机**：可能维护ARP缓存、路由表等
    
- **带ACL/QoS的交换机**：可能需要维护流分类规则
    
- **SDN交换机**：可能维护OpenFlow流表项

~~~



