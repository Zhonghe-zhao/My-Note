
[æ•°æ®åº“è®²åº§](https://db.cs.cmu.edu/seminar2022/)

[Gradescope è¯„åˆ†](https://www.gradescope.com/)

é‚€è¯·ç ï¼š PXWVR5

åŠ å…¥Discordè®¨è®ºé—®é¢˜

![[æ•°æ®åº“.png]]



#### **åŒºå—é“¾ä¸ä¼ ç»Ÿæ•°æ®åº“çš„åŒºåˆ«**

|ç‰¹æ€§|åŒºå—é“¾|ä¼ ç»Ÿæ•°æ®åº“|
|---|---|---|
|**æ•°æ®å­˜å‚¨æ–¹å¼**|åˆ†å¸ƒå¼å­˜å‚¨ï¼Œæ•°æ®å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šã€‚|é›†ä¸­å¼å­˜å‚¨ï¼Œæ•°æ®å­˜å‚¨åœ¨ä¸­å¿ƒæœåŠ¡å™¨ä¸Šã€‚|
|**æ•°æ®ä¿®æ”¹**|æ•°æ®ä¸€æ—¦å†™å…¥ï¼Œå‡ ä¹ä¸å¯ä¿®æ”¹ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰ã€‚|æ•°æ®å¯ä»¥éšæ—¶ä¿®æ”¹æˆ–åˆ é™¤ã€‚|
|**æ•°æ®ä¸€è‡´æ€§**|é€šè¿‡å…±è¯†æœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚|é€šè¿‡äº‹åŠ¡ï¼ˆTransactionï¼‰ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚|
|**æ•°æ®é€æ˜åº¦**|æ•°æ®å¯¹æ‰€æœ‰å‚ä¸è€…å…¬å¼€ï¼ˆå…¬æœ‰é“¾ï¼‰ã€‚|æ•°æ®é€šå¸¸å¯¹ç‰¹å®šç”¨æˆ·æˆ–ç®¡ç†å‘˜å¼€æ”¾ã€‚|
|**æ•°æ®å®‰å…¨æ€§**|é€šè¿‡åŠ å¯†å’Œå…±è¯†æœºåˆ¶ç¡®ä¿å®‰å…¨æ€§ã€‚|é€šè¿‡æƒé™ç®¡ç†å’ŒåŠ å¯†ç¡®ä¿å®‰å…¨æ€§ã€‚|


### **UUID çš„åº”ç”¨åœºæ™¯**

1. **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼š
    
    - åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒUUID ç”¨äºå”¯ä¸€æ ‡è¯†èµ„æºã€å¯¹è±¡æˆ–å®ä½“ï¼Œé¿å…å†²çªã€‚
        
2. **æ•°æ®åº“ä¸»é”®**ï¼š
    
    - UUID å¯ä»¥ç”¨ä½œæ•°æ®åº“è¡¨çš„ä¸»é”®ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€æ€§ã€‚
        
3. **æ–‡ä»¶å‘½å**ï¼š
    
    - åœ¨æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿä¸­ï¼ŒUUID å¯ä»¥ç”¨ä½œæ–‡ä»¶åï¼Œé¿å…é‡å¤ã€‚
        
4. **ä¼šè¯æ ‡è¯†**ï¼š
    
    - åœ¨ Web åº”ç”¨ä¸­ï¼ŒUUID å¯ä»¥ç”¨ä½œä¼šè¯ IDï¼Œç¡®ä¿å”¯ä¸€æ€§ã€‚
        
5. **æ¶ˆæ¯é˜Ÿåˆ—**ï¼š
    
    - åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼ŒUUID å¯ä»¥ç”¨ä½œæ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚

---

####  å…‹éš†æ–¹æ³•:

`git clone --bare https://github.com/cmu-db/bustub.git bustub-public`

cd bustub-public

pushåˆ°ä¸ªäººçš„ç§æœ‰ä»“åº“

` git push https://github.com/student/bustub-private.git master`

åˆ é™¤ä¸»ä»“åº“

å°†ç§æœ‰ä»“åº“å…‹éš†åˆ°å¼€å‘è®¡ç®—æœº


#### å­—å…¸æ ‘ï¼šï¼ˆtrieï¼‰

æ£€ç´¢å­—ç¬¦ä¸²


![[Trie Tree.png]]



` find /CMU15445/bustub -name "trie.h"` å¯»æ‰¾ â€œtire.hâ€ â€œtire.cppâ€



#### å†™æ—¶å¤åˆ¶



### Lecture2 SQL

å…³ç³»æ•°æ®æ¨¡å‹

å…³ç³»å‹æ•°æ®åº“

éå…³ç³»å‹æ•°æ®ï¼š JSON

å¤ªå¸…è¾£ï¼

![[åè¨€.png]]


DDL

DCL 

DML

#### å…³ç³»ä»£æ•° && å…³ç³»è¿ç®—


- **å…³ç³»ï¼ˆRelationï¼‰**ï¼šå¯¹åº”æ•°æ®åº“ä¸­çš„ä¸€å¼ è¡¨ï¼ˆå¦‚Â `Students`Â è¡¨ï¼‰ã€‚
    
- **å…ƒç»„ï¼ˆTupleï¼‰**ï¼šè¡¨ä¸­çš„ä¸€è¡Œæ•°æ®ï¼ˆå¦‚ä¸€ä¸ªå­¦ç”Ÿçš„è®°å½•ï¼‰ã€‚
    
- **å±æ€§ï¼ˆAttributeï¼‰**ï¼šè¡¨ä¸­çš„ä¸€åˆ—ï¼ˆå¦‚Â `student_id`ã€`name`ï¼‰ã€‚
    
- **åŸŸï¼ˆDomainï¼‰**ï¼šå±æ€§çš„å–å€¼èŒƒå›´ï¼ˆå¦‚Â `age`Â çš„åŸŸæ˜¯æ•´æ•°ï¼‰ã€‚


#### **ç¤ºä¾‹ï¼šå¹¶é›†ï¼ˆUnionï¼‰**

```sql
-- SQLå®ç°
SELECT * FROM students_2022
UNION
SELECT * FROM students_2023;
```

ç­‰ä»·äºï¼š 

students_2022    âˆª   students_2023

#### **ç¤ºä¾‹1ï¼šé€‰æ‹©ï¼ˆSelectionï¼‰**

```sql
-- SQLå®ç°
SELECT * FROM Students WHERE age > 20;
```


#### **ç¤ºä¾‹2ï¼šæŠ•å½±ï¼ˆProjectionï¼‰**

```sql
-- SQLå®ç°
SELECT name, student_id FROM Students;
```

#### **ç¤ºä¾‹3ï¼šè‡ªç„¶è¿æ¥ï¼ˆNatural Joinï¼‰**

```sql
-- SQLå®ç°
SELECT * FROM Students NATURAL JOIN Courses;
```

è¿æ¥Â `Students`Â å’ŒÂ `Courses`Â è¡¨ï¼ˆè‡ªåŠ¨åŒ¹é…åŒåå±æ€§ï¼‰


#### é€‰æ‹©å’ŒæŠ•å½±çš„åŒºåˆ«

| **é€‰æ‹©ï¼ˆÏƒï¼‰** | **æŠ•å½±ï¼ˆÏ€ï¼‰** |       |
| --------- | --------- | ----- |
| **ä½œç”¨å¯¹è±¡**  | è¡Œï¼ˆå…ƒç»„ï¼‰     | åˆ—ï¼ˆå±æ€§ï¼‰ |



 **å…³ç³»ä»£æ•°çš„ç»„åˆä½¿ç”¨**

 **â€œé€‰ä¿®äº†æ•°å­¦è¯¾çš„å­¦ç”Ÿå§“åâ€**

æŠ•å½±æ•°å­¦ && è¿æ¥é€‰è¯¾è¡¨ && è¿æ¥å­¦ç”Ÿè¡¨ && æŠ•å½±åå­—

### **æ•°æ®è¡¨ç»“æ„**

å‡è®¾æˆ‘ä»¬æœ‰3å¼ è¡¨ï¼š

1. **Studentsï¼ˆå­¦ç”Ÿè¡¨ï¼‰**
    
    |student_id|name|age|
    |---|---|---|
    |1|Alice|20|
    |2|Bob|22|
    
2. **Coursesï¼ˆè¯¾ç¨‹è¡¨ï¼‰**
    
    |course_id|course_name|
    |---|---|
    |101|Math|
    |102|Physics|
    
3. **Enrollmentsï¼ˆé€‰è¯¾è®°å½•è¡¨ï¼‰**
    
    |enrollment_id|student_id|course_id|
    |---|---|---|
    |1001|1|101|
    |1002|2|101|
    |1003|1|102|


```sql
SELECT Students.name
FROM Students
JOIN Enrollments ON Students.student_id = Enrollments.student_id
JOIN Courses ON Enrollments.course_id = Courses.course_id
WHERE Courses.course_name = 'Math';
```


**GROUP BYçš„ä½œç”¨ï¼š**

```SQL
-- è®¡ç®—æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„
SELECT department, AVG(salary) 
FROM employees
GROUP BY department;
```

**SELECT ä¸­çš„éèšåˆåˆ—å¿…é¡»å‡ºç°åœ¨ GROUP BY ä¸­**

é€šè¿‡è¿™ç§åˆ†é˜¶æ®µçš„ç†è§£æ–¹å¼ï¼Œä½ åº”è¯¥èƒ½å½»åº•æŒæ¡ä¸‰è€…çš„åŒºåˆ«äº†ï¼å®é™…å†™SQLæ—¶ï¼Œè®°ä½è¿™ä¸ªæ‰§è¡Œé¡ºåºï¼š  
**WHERE â†’ GROUP BY â†’ HAVING â†’ SELECT**


 *SELECT LOWER(name) FROM student WHERE name = â€™Tupacâ€˜*

å…ˆç­›é€‰ name = Tupac å«æœ‰å¤§å†™å­—æ¯ ä¹‹å æ”¹ä¸ºå°å†™ 


#### é—®é¢˜
ä¸ºä»€ä¹ˆä¸åŒçš„æ•°æ®åº“ é‡‡ç”¨äº†ä¸åŒçš„è¯­æ³•


---


`ORDER BY` æ˜¯ SQL ä¸­ç”¨æ¥å¯¹æŸ¥è¯¢ç»“æœè¿›è¡Œ**æ’åº**çš„è¯­å¥

`RANKï¼ˆï¼‰` å‘Šè¯‰å½“å‰çš„ä½ç½®





`SELECT cid, sid ROW_NUMBER() OVER (PARTITION BY cid) FROM enrolled ORDER BY cid`
è¿™å¥è¯ç›¸å½“äº***åˆ†åŒºæ’å***


`ROW_NUMBER() OVER (...)`ï¼šçª—å£å‡½æ•°ï¼Œä¸ºæ¯ä¸€è¡Œç”Ÿæˆä¸€ä¸ª**åºå·**ï¼ˆä» 1 å¼€å§‹ï¼‰


åµŒå¥—ï¼š

*SELECT * FROM ï¼ˆ*
	*SELECT * ï¼Œ RANKï¼ˆï¼‰ OVER ï¼ˆPARTITION BY cid ORDER BY grade ASCï¼‰AS rank*
*FROM enrolledï¼‰AS ranking WHERE ranking.rank = 2*

`PARTITION BY` ä½¿å¾—çª—å£å‡½æ•°åœ¨åˆ†ç»„åè®¡ç®—æ¯ä¸€ç»„çš„æ•°æ®ï¼Œç±»ä¼¼äº `GROUP BY`ï¼Œä½†ä¸ `GROUP BY` ä¸åŒçš„æ˜¯ï¼Œ`PARTITION BY` **ä¸ä¼šåˆå¹¶ç»“æœè¡Œ**ï¼Œå®ƒåªæ˜¯å®šä¹‰äº†è®¡ç®—çš„â€œçª—å£â€èŒƒå›´ã€‚



#### èšåˆå‡½æ•°å‚æ•°

å¯¹ä¸€ç»„å€¼è¿›è¡Œè®¡ç®—å¹¶è¿”å›å•ä¸€çš„å€¼ï¼Œé€šå¸¸èšåˆå‡½æ•°ä¼šä¸SELECTè¯­å¥çš„GROUP BYå­å¥ä¸€åŒä½¿ç”¨

*GROUP BYä¸ä¹‹æœ‰ä»€ä¹ˆåŒºåˆ«*ï¼Ÿèƒ½ä¸èƒ½ä½¿ç”¨GROUP BYè¾¾åˆ°åŒæ ·çš„æ•ˆæœå‘¢

1. **GROUP BY ä¼šèšåˆæ•°æ®**ï¼Œä¸¢å¤±åŸå§‹è¡Œçš„è¯¦ç»†ä¿¡æ¯
    
2. **RANK() OVER ä¿ç•™æ‰€æœ‰è¡Œ**ï¼Œåªæ˜¯æ·»åŠ æ’åä¿¡æ¯

#### åµŒå¥—æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢ï¼‰

*SELECT * FROM ï¼ˆSELECT * ï¼Œ ROW_NUMBER() OVER (PARTITION BY cid ORDER BY grade ASC) AS rank FROM enrolledï¼‰AS ranking*

æˆ‘æ€ä¹ˆç†è§£è¿™ä¸ªåµŒå¥—è¯­å¥ 

***ä¼˜åŒ–éš¾åº¦å¾ˆé«˜***

 *IN*å…³é”®å­—

```sql
SELECT åˆ—å
FROM è¡¨å
WHERE åˆ—å IN (SELECT åˆ—å FROM å¦ä¸€è¡¨ WHERE æ¡ä»¶);
```


**å¤šå€¼åŒ¹é…**ï¼šæ›¿ä»£å¤šä¸ªÂ `OR`Â æ¡ä»¶

```sql
-- ä½¿ç”¨ OR
WHERE åˆ—å = å€¼1 OR åˆ—å = å€¼2 OR åˆ—å = å€¼3

-- ä½¿ç”¨ IN (æ›´ç®€æ´)
WHERE åˆ—å IN (å€¼1, å€¼2, å€¼3)
```

**å­æŸ¥è¯¢è¿‡æ»¤**ï¼šæ£€æŸ¥å€¼æ˜¯å¦å­˜åœ¨äºå­æŸ¥è¯¢ç»“æœä¸­

```sql
WHERE åˆ—å IN (SELECT åˆ—å FROM å¦ä¸€è¡¨)
```


![[åµŒå¥—æŸ¥è¯¢.png]]


*EXPLAIN*å…³é”®å­—çš„ä½œç”¨

`EXPLAIN` æ˜¯ SQL ä¸­ç”¨æ¥**åˆ†ææŸ¥è¯¢è¯­å¥æ‰§è¡Œè®¡åˆ’**çš„å…³é”®å­—ï¼Œä½œç”¨æ˜¯ï¼š

 ğŸ‘‰ æŸ¥çœ‹ SQL çš„æ‰§è¡Œæ–¹å¼ï¼Œæ¯”å¦‚ï¼š

- ç”¨äº†å“ªäº›ç´¢å¼•ï¼ˆè¿˜æ˜¯æ²¡ç”¨ï¼‰
    
- å“ªäº›è¡¨åšäº†å…¨è¡¨æ‰«æ
    
- è¡Œæ•°ä¼°è®¡
    
- è”æ¥æ–¹å¼ï¼ˆNested Loop / Hash Join / Merge Joinï¼‰
    
- æ’åºã€è¿‡æ»¤ç­‰æ“ä½œæ˜¯å¦å‘ç”Ÿ


![[EXPLAIN.png]]




#### å“ˆå¸Œè¿æ¥

#### æ¨ªå‘é“¾æ¥

`LATERAL` æ˜¯ SQL ä¸­çš„ä¸€ä¸ªé«˜çº§è¯­æ³•ï¼Œä½œç”¨æ˜¯**è®©å­æŸ¥è¯¢å¯ä»¥å¼•ç”¨å¤–å±‚æŸ¥è¯¢çš„åˆ—**ï¼Œä¹Ÿå«â€œæ¨ªå‘è¿æ¥â€ã€‚


ç¤ºä¾‹ï¼š

å‡è®¾æœ‰ä¸¤å¼ è¡¨ï¼š

- `users(id, name)`
    
- `orders(id, user_id, price)`
    

**æƒ³æŸ¥å‡ºæ¯ä¸ªç”¨æˆ·æœ€æ–°ä¸€ç¬”è®¢å•ï¼š**

```sql
SELECT u.name, o.price
FROM users u,
LATERAL (
    SELECT price
    FROM orders
    WHERE orders.user_id = u.id
    ORDER BY id DESC
    LIMIT 1
) o;

```

### ğŸ” è§£é‡Šï¼š

- æ¯ä¸€è¡Œç”¨æˆ· `u` éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢ `o`
    
- å­æŸ¥è¯¢ä¸­å¯ä»¥ç”¨ `u.id`ï¼Œè¿™åœ¨æ™®é€šå­æŸ¥è¯¢é‡Œåšä¸åˆ°
    
- æœ€ç»ˆè¿”å›æ¯ä¸ªç”¨æˆ·çš„æœ€è¿‘ä¸€æ¡è®¢å•ä»·æ ¼

 ![[LATERAL ç”¨æ³•.png]]

#### å…¬å…±è¡¨è¾¾å¼

CTEs
```sql
WITH cteName (col1, cole2) AS (
	SELECT 1, 2
)
SELECT col1 + col2 FROM cteName
```



## sql 1

` zip -j submission.zip placeholder/*.sql`


### sqlite3:

```sql
CREATE INDEX ix_people_name ON people (name);
CREATE INDEX ix_titles_type ON titles (type);
CREATE INDEX ix_titles_primary_title ON titles (primary_title);
CREATE INDEX ix_titles_original_title ON titles (original_title);
CREATE INDEX ix_akas_title_id ON akas (title_id);
CREATE INDEX ix_akas_title ON akas (title);
CREATE INDEX ix_crew_title_id ON crew (title_id);
CREATE INDEX ix_crew_person_id ON crew (person_id);
```

åˆ›å»ºç´¢å¼•

`.schema $TABLE_NAME` æŸ¥çœ‹è¡¨ç»“æ„


```sql
sqlite> .schema people
CREATE TABLE people (
  person_id VARCHAR PRIMARY KEY,
  name VARCHAR,
  born INTEGER,
  died INTEGER
);
CREATE INDEX ix_people_name ON people (name);
```


è¦æœ‰ä¸€ä¸ªæŸ¥è¯¢æ€è·¯

 æ€»ç»“æˆæ€ç»´æµç¨‹ï¼š

1. ä»å“ªå¼ è¡¨æŸ¥ï¼Ÿï¼ˆ`FROM`ï¼‰
    
2. å–ä»€ä¹ˆå­—æ®µï¼Ÿï¼ˆ`SELECT`ï¼‰
    
3. è¿‡æ»¤å“ªäº›è¡Œï¼Ÿï¼ˆ`WHERE`ï¼‰
    
4. ç»“æœæ€ä¹ˆæ’ï¼Ÿï¼ˆ`ORDER BY`ï¼‰
    
5. è¦å‡ æ¡æ•°æ®ï¼Ÿï¼ˆ`LIMIT`ï¼‰



[homework1](https://15445.courses.cs.cmu.edu/spring2023/homework1/)


#### JOIN çš„ä½œç”¨æ˜¯ä»€ä¹ˆ  :

**æŠŠå¤šä¸ªè¡¨æŒ‰ç…§æŸä¸ªæ¡ä»¶è¿æ¥èµ·æ¥ï¼Œç»„åˆæˆä¸€ä¸ªæ–°ç»“æœé›†**ã€‚
 
`JOIN` = æŠŠ**æœ‰å…³ç³»çš„è¡¨**â€œè¿â€åœ¨ä¸€èµ·æŸ¥ã€‚



JOIN å’Œ åµŒå¥— 

```sql
SELECT p.name
FROM people p
JOIN crew c ON p.person_id = c.person_id
WHERE c.category = 'director';
```

```sql
SELECT name
FROM people
WHERE person_id IN (
  SELECT person_id
  FROM crew
  WHERE category = 'director'
);
```

### âœ… æ¨è

- ç®€å•éœ€æ±‚ï¼Œå­æŸ¥è¯¢å¯ä»¥ã€‚
    
- å¤šè¡¨è”åˆã€å¤æ‚é€»è¾‘æˆ–é«˜æ€§èƒ½è¦æ±‚ï¼Œ**æ¨èç”¨ `JOIN`**ã€‚

#### é—®é¢˜

GROUP BY (born / 10) * 10 å’Œ ORDER BYæ˜¯å•¥åŒºåˆ« éƒ½æ˜¯å¹²ä»€ä¹ˆçš„


|å­å¥|ä½œç”¨|ä¸¾ä¾‹|
|---|---|---|
|`GROUP BY`|åˆ†ç»„ï¼ŒæŠŠæ•°æ®**èšåˆ**èµ·æ¥|æŒ‰å‡ºç”Ÿåå¹´åˆ†ç»„ç»Ÿè®¡äººæ•°|
|`ORDER BY`|æ’åºï¼ŒæŠŠæ•°æ®**æ’åºè¾“å‡º**|æŒ‰å‡ºç”Ÿå¹´ä»½å‡åº/é™åºæ’åˆ—|


æˆ‘çš„é”™è¯¯å†™æ³•ï¼š

```sql
SELECT

Â  Â  a.types AS TITLE_TYPE,

Â  Â  AVG(r.rating) AS average_rating,

Â  Â  MIN(r.rating) AS min_rating,

Â  Â  MAX(r.rating) AS max_rating,

FROM

Â  Â  ratings r

JOIN

Â  Â  akas a ON r.title_id = a.title_id

WHERE

Â  Â  a.language = 'German'

Â  Â  a.type = 'imdbDisplay','original';
```

ä¿®æ­£

```sql
SELECT

Â  Â  a.types AS TITLE_TYPE,

Â  Â  ROUND(AVG(r.rating),2) AS AVG_RATING,

Â  Â  MIN(r.rating) AS MIN_RATING,

Â  Â  MAX(r.rating) AS MAX_RATING

FROM

Â  Â  ratings r

JOIN

Â  Â  akas a ON r.title_id = a.title_id

WHERE

Â  Â  a.language = 'German'

Â  Â  AND a.types IN ('imdbDisplay','original')

GROUP BY

Â  Â  a.types

ORDER BY

Â  Â  AVG_RATING;
```

ä¸ºä»€ä¹ˆç”¨AND 

ä½ è¿˜æƒ³**å†åŠ ä¸€ä¸ªæ¡ä»¶**ï¼Œé™åˆ¶ `a.types` æ˜¯ `'imdbDisplay'` æˆ– `'original'`ï¼Œè¿™å°±æ˜¯**ç¬¬äºŒä¸ªæ¡ä»¶**ï¼Œæ‰€ä»¥éœ€è¦ç”¨ `AND` æ¥è¿æ¥ä¸¤ä¸ªæ¡ä»¶ï¼š


```sql
SELECT

Â  Â  p.name || '|' || ROUND(AVG(r.rating),2) AS formatted_output

FROM

Â  Â  crew c

JOIN

Â  Â  people p ON c.person_id = p.person_id

JOIN

Â  Â  ratings r ON c.title_id = r.title_id

WHERE

Â  Â  c.category = 'actor'

Â  Â  AND c.characters = 'Batman'

GROUP BY

Â  Â  p.name

ORDER BY

Â  Â  AVG(r.rating) DESC

LIMIT 10;
```

æ•´å¥—è¯­å¥çš„æ‰§è¡Œé¡ºåº

- **`FROM crew c`**
    
    - å…ˆä» `crew` è¡¨å¼€å§‹è¯»å–æ•°æ®ã€‚
        
- **`JOIN people p ON c.person_id = p.person_id`**
    
    - æŠŠ `crew` è¡¨å’Œ `people` è¡¨é€šè¿‡ `person_id` è¿æ¥èµ·æ¥ã€‚
        
- **`JOIN ratings r ON c.title_id = r.title_id`**
    
    - å†å°†å·²æœ‰çš„ç»“æœå’Œ `ratings` è¡¨é€šè¿‡ `title_id` è¿æ¥èµ·æ¥ã€‚
        
- **`WHERE c.category = 'actor' AND c.characters = 'Batman'`**
    
    - å¯¹è¿æ¥åçš„å¤§è¡¨è¿›è¡Œç­›é€‰ï¼Œä¿ç•™åªæ¼”è¿‡ Batman çš„æ¼”å‘˜ï¼Œä¸”æ˜¯ `actor` ç±»åˆ«çš„è®°å½•ã€‚
        
- **`GROUP BY p.name`**
    
    - æ ¹æ®æ¼”å‘˜åå­—è¿›è¡Œåˆ†ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä½æ¼”å‘˜ä¸€ç»„ã€‚
        
- **`AVG(r.rating)`**
    
    - å¯¹æ¯ç»„ï¼ˆæ¯ä¸ªæ¼”å‘˜ï¼‰è®¡ç®—ä»–ä»¬æ‰€æœ‰ä½œå“çš„å¹³å‡è¯„åˆ†ã€‚
        
- **`SELECT p.name || '|' || ROUND(AVG(r.rating),2) AS formatted_output`**
    
    - é€‰å‡ºä½ æƒ³å±•ç¤ºçš„å­—æ®µï¼Œè¿™é‡Œæ˜¯åå­—æ‹¼æ¥ä¸Šå¹³å‡åˆ†ã€‚
        
- **`ORDER BY AVG(r.rating) DESC`**
    
    - æŒ‰ç…§å¹³å‡è¯„åˆ†é™åºæ’åºã€‚
        
- **`LIMIT 10`**
    
    - æœ€ååªå–å‰ 10 è¡Œã€‚


---
#### ç¬¬ä¹ä¸ª

å¦‚ä½•æ°å½“ä½¿ç”¨ GROUP BY ï¼

æˆ‘ä»¬éœ€è¦åœ¨ **æ¯ä¸ªè‰ºæœ¯å®¶æ‰€æœ‰ä½œå“ä¸­ï¼Œæ‰¾å‡ºæœ€é•¿ runtime çš„é‚£ä¸€ä¸ªä½œå“**ï¼Œå¹¶åœ¨å¤šä¸ªä½œå“ runtime ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé€‰å‡º `title_id` æœ€å°çš„ã€‚

è¿™å°±éœ€è¦ **ä¸€ä¸ªå­æŸ¥è¯¢ + ROW_NUMBER æ’åº runtime_minutesï¼Œå†æŒ‰ title_id æ‰“ç ´å¹¶åˆ—**ã€‚


**çª—å£å‡½æ•°ä½¿ç”¨**ï¼š

- `ROW_NUMBER() OVER (PARTITION BY...)`æ­£ç¡®å®ç°åˆ†ç»„æ’å

```sql
WITH artist_works AS (

Â  Â  SELECT

Â  Â  Â  Â  c.category,

Â  Â  Â  Â  p.name,

Â  Â  Â  Â  p.died,

Â  Â  Â  Â  t.title,

Â  Â  Â  Â  t.runtime_minutes,

Â  Â  Â  Â  t.title_id

Â  Â  FROM crew c

Â  Â  JOIN people p ON c.person_id = p.person_id

Â  Â  JOIN titles t ON c.title_id = t.title_id

Â  Â  WHERE c.category = 'artist'

Â  Â  Â  AND p.died IS NOT NULL

Â  Â  Â  AND t.runtime_minutes IS NOT NULL

),

longest_per_artist AS (

Â  Â  SELECT *,

Â  Â  Â  Â  ROW_NUMBER() OVER (

Â  Â  Â  Â  Â  Â  PARTITION BY category, name, died

Â  Â  Â  Â  Â  Â  ORDER BY runtime_minutes DESC, title_id ASC

Â  Â  Â  Â  ) AS rn

Â  Â  FROM artist_works

),

top5_per_category AS (

Â  Â  SELECT *,

Â  Â  Â  Â  ROW_NUMBER() OVER (

Â  Â  Â  Â  Â  Â  PARTITION BY category

Â  Â  Â  Â  Â  Â  ORDER BY died ASC, name ASC

Â  Â  Â  Â  ) AS category_rank

Â  Â  FROM longest_per_artist

Â  Â  WHERE rn = 1

)

SELECT

Â  Â  category AS CATEGORY,

Â  Â  name AS NAME,

Â  Â  died AS DEATH_YEAR,

Â  Â  title AS LONGEST_WORK_TITLE,

Â  Â  runtime_minutes AS WORK_RUNTIME,

Â  Â  category_rank AS CATEGORY_RANK

FROM top5_per_category

WHERE category_rank <= 5

ORDER BY category ASC, died ASC, name ASC;
```


emmmméœ€è¦ç†è§£ä¸€é˜µå­

çª—å£å‡½æ•° 

```sql
ROW_NUMBER() OVER (

Â  Â  Â  Â  Â  Â  PARTITION BY c.category

Â  Â  Â  Â  Â  Â  ORDER BY p.died ASC, p.name ASC

Â  Â  Â  Â  ) AS category_rank
```

### æ ¸å¿ƒåŠŸèƒ½åˆ†è§£

1. **`PARTITION BY c.category`**ï¼š
    
    - å°†æ•°æ®æŒ‰ç…§è§’è‰²ç±»åˆ«ï¼ˆå¦‚ actorã€director ç­‰ï¼‰åˆ†ç»„
        
    - æ¯ä¸ªç±»åˆ«ç»„å†…çš„æ’åè®¡ç®—ç›¸äº’ç‹¬ç«‹
        
2. **`ORDER BY p.died ASC, p.name ASC`**ï¼š
    
    - åœ¨æ¯ä¸ªç±»åˆ«ç»„å†…ï¼Œå…ˆæŒ‰è‰ºæœ¯å®¶çš„å»ä¸–å¹´ä»½ï¼ˆdiedï¼‰å‡åºæ’åˆ—
        
    - å¦‚æœå»ä¸–å¹´ä»½ç›¸åŒï¼Œå†æŒ‰è‰ºæœ¯å®¶å§“åï¼ˆnameï¼‰å­—æ¯é¡ºåºå‡åºæ’åˆ—
        
3. **`ROW_NUMBER()`**ï¼š
    
    - ä¸ºæ¯ç»„å†…çš„æ¯è¡Œæ•°æ®åˆ†é…ä¸€ä¸ªå”¯ä¸€åºå·ï¼ˆä»1å¼€å§‹ï¼‰
        
    - åºå·æŒ‰ç…§æŒ‡å®šçš„æ’åºè§„åˆ™ç”Ÿæˆ



#### åŒ¹é…ç²¾åº¦


```sql
`c.characters = 'Batman'` å¤ªä¸¥æ ¼äº†

è€Œåº”è¯¥ä½¿ç”¨

AND c.characters LIKE '%Batman%'

```


è¡¨ç¤ºåªè¦å­—æ®µ **åŒ…å«** `Batman` å­ä¸²å°±èƒ½åŒ¹é…åˆ°ï¼Œä¸ç®¡å‰é¢åé¢æœ‰æ²¡æœ‰å¼•å·ã€å…¶ä»–è§’è‰²æˆ–è€…æ–¹æ‹¬å·ã€‚

è¿™æ˜¯å¤„ç†ç±»ä¼¼ `["Bruce Wayne", "Batman"]` è¿™ç§å­—æ®µçš„ç®€å•æœ‰æ•ˆæ–¹å¼ã€‚

