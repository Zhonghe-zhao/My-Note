
**å…ƒæ•°æ®ï¼ˆMetadataï¼‰** åœ¨ gRPC ä¸­çš„ä½œç”¨ä¸»è¦æ˜¯ **åœ¨å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´ä¼ é€’é¢å¤–çš„ä¿¡æ¯**ï¼Œç±»ä¼¼äº HTTP å¤´éƒ¨ï¼ˆHeadersï¼‰ã€‚åœ¨ gRPC è¯·æ±‚ä¸­ï¼Œå…ƒæ•°æ® **ä¸ä¼šå½±å“ä¸»è¦çš„ä¸šåŠ¡é€»è¾‘**ï¼Œä½†å¯ä»¥ç”¨äº **èº«ä»½éªŒè¯ã€è¯·æ±‚è¿½è¸ªã€æ—¥å¿—è®°å½•ã€æµé‡æ§åˆ¶ç­‰** å…³é”®åŠŸèƒ½ã€‚

---

## **1. å…ƒæ•°æ®çš„ä½œç”¨**

### âœ… **1.1 è®¤è¯ & æˆæƒ**

- æœåŠ¡å™¨å¯ä»¥ä»å…ƒæ•°æ®ä¸­æå– **JWT Token** æˆ– **API Key**ï¼Œè¿›è¡Œèº«ä»½éªŒè¯ï¼š
    
    ```go
    if md, ok := metadata.FromIncomingContext(ctx); ok {
        tokens := md.Get("authorization")
        if len(tokens) > 0 {
            authToken := tokens[0]
            // éªŒè¯ authToken æ˜¯å¦æœ‰æ•ˆ
        }
    }
    ```
    
- å¸¸ç”¨äº **OAuthã€JWT è®¤è¯** æœºåˆ¶ã€‚

---

### âœ… **1.2 è¯·æ±‚è¿½è¸ª & åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª**

- gRPC åœ¨ **åˆ†å¸ƒå¼ç³»ç»Ÿ** ä¸­å¯ä»¥ä½¿ç”¨ **Trace ID**ï¼Œå¸®åŠ©è·Ÿè¸ªè¯·æ±‚çš„å…¨é“¾è·¯ï¼š
    
    ```go
    if md, ok := metadata.FromIncomingContext(ctx); ok {
        traceID := md.Get("x-trace-id")
        if len(traceID) > 0 {
            fmt.Println("Trace ID:", traceID[0])
        }
    }
    ```
    
- ç»“åˆ **OpenTelemetry / Jaeger** è¿›è¡Œ **æ—¥å¿—å…³è” & è°ƒè¯•**ã€‚

---

### âœ… **1.3 æ—¥å¿— & ç›‘æ§**

- æœåŠ¡å™¨å¯ä»¥ **è®°å½• `User-Agent` å’Œ `Client-IP`**ï¼Œç”¨äºæ—¥å¿—åˆ†æï¼š
    
    ```go
    if md, ok := metadata.FromIncomingContext(ctx); ok {
        userAgent := md.Get("user-agent")
        clientIP := md.Get("x-forwarded-for")
        log.Infof("User-Agent: %s, Client-IP: %s", userAgent, clientIP)
    }
    ```
    
- å¯ç”¨äº **ç”¨æˆ·è¡Œä¸ºåˆ†æ & é£æ§ç­–ç•¥**ã€‚

---

### âœ… **1.4 è´Ÿè½½å‡è¡¡ & è·¯ç”±**

- åœ¨ **å¾®æœåŠ¡æ¶æ„** ä¸‹ï¼Œå…ƒæ•°æ®å¯ä»¥ä¼ é€’ **åœ°åŒºä¿¡æ¯ã€ç§Ÿæˆ·ä¿¡æ¯**ï¼Œå®ç°æ™ºèƒ½è·¯ç”±ï¼š
    
    ```go
    if md, ok := metadata.FromIncomingContext(ctx); ok {
        region := md.Get("x-region")
        if len(region) > 0 && region[0] == "us-east-1" {
            routeToUSCluster()
        }
    }
    ```
    
- **äº‘æœåŠ¡ & å¤šç§Ÿæˆ·** åœºæ™¯éå¸¸å¸¸è§ã€‚

---

### âœ… **1.5 ä¼ é€’è‡ªå®šä¹‰æ•°æ®**

- gRPC **æ”¯æŒè‡ªå®šä¹‰ key-value æ•°æ®**ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨å…ƒæ•°æ®ä¸­åŠ å…¥ **é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼š
    
    ```go
    md := metadata.Pairs("custom-key", "custom-value")
    ctx := metadata.NewOutgoingContext(context.Background(), md)
    ```
    
- é€‚ç”¨äº **ç°åº¦å‘å¸ƒã€A/B æµ‹è¯•** ç­‰ç­–ç•¥ã€‚

---

## **2. gRPC å…ƒæ•°æ®çš„ç‰¹ç‚¹**

ğŸ”¹ **åªåœ¨å•æ¬¡ RPC è°ƒç”¨å†…ç”Ÿæ•ˆ**ï¼Œä¸ä¼šè·¨å¤šä¸ªè¯·æ±‚æŒä¹…åŒ–ã€‚  
ğŸ”¹ **åˆ†ä¸ºè¯·æ±‚å…ƒæ•°æ®ï¼ˆIncomingï¼‰å’Œå“åº”å…ƒæ•°æ®ï¼ˆOutgoingï¼‰**ã€‚  
ğŸ”¹ **æ”¯æŒåŒå‘ä¼ é€’**ï¼Œå®¢æˆ·ç«¯å¯ä»¥å‘é€å…ƒæ•°æ®ï¼ŒæœåŠ¡å™¨ä¹Ÿå¯ä»¥è¿”å›å…ƒæ•°æ®ã€‚

---

## **3. ä»£ç ç¤ºä¾‹**

### **å®¢æˆ·ç«¯è®¾ç½®å…ƒæ•°æ®**

```go
import (
	"context"
	"google.golang.org/grpc"
	"google.golang.org/grpc/metadata"
)

func main() {
	conn, _ := grpc.Dial("localhost:50051", grpc.WithInsecure())
	defer conn.Close()
	client := NewMyServiceClient(conn)

	// åˆ›å»ºå…ƒæ•°æ®
	md := metadata.Pairs("authorization", "Bearer my-jwt-token")
	ctx := metadata.NewOutgoingContext(context.Background(), md)

	// å‘é€ RPC è¯·æ±‚
	resp, _ := client.MyMethod(ctx, &MyRequest{})
	fmt.Println(resp)
}
```

### **æœåŠ¡å™¨è§£æå…ƒæ•°æ®**

```go
import (
	"context"
	"fmt"
	"google.golang.org/grpc/metadata"
)

func (s *MyService) MyMethod(ctx context.Context, req *MyRequest) (*MyResponse, error) {
	if md, ok := metadata.FromIncomingContext(ctx); ok {
		if tokens := md.Get("authorization"); len(tokens) > 0 {
			fmt.Println("Received Token:", tokens[0])
		}
	}
	return &MyResponse{}, nil
}
```

---

## **æ€»ç»“**

gRPC å…ƒæ•°æ® **ç±»ä¼¼äº HTTP å¤´éƒ¨**ï¼Œä½†æ›´çµæ´»ï¼Œå¸¸ç”¨äºï¼š âœ… **è®¤è¯ & æˆæƒ**ï¼ˆJWTã€OAuthï¼‰  
âœ… **æ—¥å¿— & ç›‘æ§**ï¼ˆUser-Agentã€IP è®°å½•ï¼‰  
âœ… **è¯·æ±‚è¿½è¸ª**ï¼ˆTrace ID ä¼ é€’ï¼‰  
âœ… **ç°åº¦å‘å¸ƒ & è´Ÿè½½å‡è¡¡**ï¼ˆè‡ªå®šä¹‰é”®å€¼ï¼‰

åœ¨ä½ çš„ `extractMetadata(ctx)` ä»£ç é‡Œï¼Œ**ä¸»è¦ä½œç”¨æ˜¯æå– `User-Agent` å’Œ `Client-IP`ï¼Œç”¨äºæ—¥å¿—ã€å®‰å…¨åˆ†æ**ã€‚ğŸš€