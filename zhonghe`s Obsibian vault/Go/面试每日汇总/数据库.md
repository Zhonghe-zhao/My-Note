
## ç´¢å¼•

ç´¢å¼•æ˜¯ä¸€ä¸ªæŒ‡å‘è¡¨ä¸­æ•°æ®çš„æŒ‡é’ˆã€‚ä¸€ä¸ªæ•°æ®åº“ä¸­çš„ç´¢å¼•ä¸ä¸€æœ¬ä¹¦çš„ç´¢å¼•ç›®å½•æ˜¯éå¸¸ç›¸ä¼¼çš„ã€‚

ä¸ç®¡æ˜¯å•åˆ—ç´¢å¼•è¿˜æ˜¯ç»„åˆç´¢å¼•ï¼Œè¯¥ç´¢å¼•å¿…é¡»æ˜¯åœ¨ WHERE å­å¥çš„è¿‡æ»¤æ¡ä»¶ä¸­ä½¿ç”¨éå¸¸é¢‘ç¹çš„åˆ—

**éšå¼ç´¢å¼•**

éšå¼ç´¢å¼•æ˜¯åœ¨åˆ›å»ºå¯¹è±¡æ—¶ï¼Œç”±æ•°æ®åº“æœåŠ¡å™¨è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•

PostgreSQL ä¼šè‡ªåŠ¨ä¸ºè¯¥åˆ—åˆ›å»ºä¸€ä¸ªéšå¼ç´¢å¼•ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ç®€åŒ–äº†ç´¢å¼•ç®¡ç†ï¼Œå¹¶ä¸”æé«˜äº†æ•°æ®åº“çš„æ€§èƒ½


ä½¿ç”¨ç´¢å¼•æ—¶ï¼Œéœ€è¦è€ƒè™‘ä¸‹åˆ—å‡†åˆ™ï¼š

- ç´¢å¼•ä¸åº”è¯¥ä½¿ç”¨åœ¨è¾ƒå°çš„è¡¨ä¸Šã€‚
- ç´¢å¼•ä¸åº”è¯¥ä½¿ç”¨åœ¨æœ‰é¢‘ç¹çš„å¤§æ‰¹é‡çš„æ›´æ–°æˆ–æ’å…¥æ“ä½œçš„è¡¨ä¸Šã€‚
- ç´¢å¼•ä¸åº”è¯¥ä½¿ç”¨åœ¨å«æœ‰å¤§é‡çš„ NULL å€¼çš„åˆ—ä¸Šã€‚
- ç´¢å¼•ä¸åº”è¯¥ä½¿ç”¨åœ¨é¢‘ç¹æ“ä½œçš„åˆ—ä¸Šã€‚



## å¤–é”®çº¦æŸ

### âœ… å®é™…ä½¿ç”¨å»ºè®®ï¼š

|åœºæ™¯|æ˜¯å¦å»ºè®®ç”¨å¤–é”®|åŸå› |
|---|---|---|
|ç®€å•ç³»ç»Ÿã€å•æœºæ•°æ®åº“|âœ… å»ºè®®ä½¿ç”¨|ä¿è¯æ•°æ®ä¸€è‡´ï¼Œå¼€å‘ç®€å•|
|é«˜å¹¶å‘/åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆå¦‚å¾®æœåŠ¡ï¼‰|âŒ é€šå¸¸ä¸ä½¿ç”¨|å¤–é”®æ— æ³•è·¨åº“ã€å½±å“æ€§èƒ½ï¼Œæ¨èåº”ç”¨å±‚ä¿è¯ä¸€è‡´æ€§|
|ä¸´æ—¶è¡¨/ä¸­é—´è¡¨|ğŸš« ä¸å»ºè®®|åŠ å¿«æ’å…¥/åˆ é™¤é€Ÿåº¦ï¼Œæ— éœ€ä¸€è‡´æ€§çº¦æŸ|

å¦‚æœåœ¨å¾®æœåŠ¡ä¸­å¦‚ä½•ç¡®ä¿è¡¨ä¹‹é—´çš„å…³è”

**ä¸ä½¿ç”¨å¤–é”®æ—¶ï¼Œè¡¨ä¹‹é—´çš„å…³ç³»é æœåŠ¡é€»è¾‘å’Œä»£ç çº¦å®šæ¥ç»´æŠ¤ï¼Œè€Œä¸æ˜¯æ•°æ®åº“æ¥å¼ºåˆ¶çº¦æŸ**ã€‚


## æ•°æ®åº“è¿ç§»

`æ•°æ®åº“è¿ç§»å°±æ˜¯â€œæ•°æ®åº“ç»“æ„çš„ Gitâ€ï¼Œæ²¡æœ‰å®ƒå°±åƒå†™ä»£ç ä¸åŠ ç‰ˆæœ¬æ§åˆ¶ä¸€æ ·æ··ä¹±`


## æ•°æ®åº“äº‹åŠ¡


##  éš”ç¦»çº§åˆ«

æ•°æ®åº“éš”ç¦»çº§åˆ«çš„ä½œç”¨æ˜¯**æ§åˆ¶å¹¶å‘äº‹åŠ¡ä¹‹é—´çš„å¯è§æ€§**ï¼Œé˜²æ­¢å¹¶å‘æ“ä½œäº§ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ¯”å¦‚**è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»**ç­‰ã€‚

### âœ… ç†è§£å…³é”®ç‚¹ï¼š

- è¿™å››ç§éš”ç¦»çº§åˆ«æ˜¯æ•°æ®åº“æä¾›çš„**å¹¶å‘æ§åˆ¶ç­–ç•¥**ï¼Œ**ä½ å¿…é¡»é€‰å…¶ä¸­ä¹‹ä¸€**ï¼›
    
- æ¯ç§éš”ç¦»çº§åˆ«éƒ½æœ‰**å¯æ¥å—çš„å¹¶å‘é—®é¢˜å’Œæ€§èƒ½ä»£ä»·**ï¼›
    
- ä½ çš„ä»»åŠ¡æ˜¯ï¼š  
    ğŸ‘‰ **ç†è§£ä½ çš„ä¸šåŠ¡èƒ½å®¹å¿ä»€ä¹ˆå¹¶å‘é—®é¢˜**ï¼Œ  
    ğŸ‘‰ ç„¶å**é€‰æœ€åˆé€‚çš„éš”ç¦»çº§åˆ«**ã€‚
    

---

### ä¸¾ä¾‹è¯´æ˜é€‰æ‹©ï¼š

| åœºæ™¯               | æ¨èéš”ç¦»çº§åˆ«            | åŸå› /è¯´æ˜             |
| ---------------- | ----------------- | ----------------- |
| é“¶è¡Œè½¬è´¦ç³»ç»Ÿï¼Œèµ„é‡‘ä¸èƒ½é”™ä¹±    | `Serializable`    | å¼ºä¸€è‡´æ€§æœ€é‡è¦ï¼Œå“ªæ€•æ€§èƒ½å·®ä¹Ÿå¾—ä¿è¯ |
| æ™®é€šåšå®¢æˆ–å†…å®¹å±•ç¤ºç³»ç»Ÿ      | `Read Committed`  | å…è®¸è½»å¾®å¹¶å‘é—®é¢˜ï¼Œæ€§èƒ½ä¼˜å…ˆ     |
| ç”µå•†ä¸‹å•ï¼Œé˜²æ­¢é‡å¤ä¸‹å•æˆ–åº“å­˜è¶…å– | `Repeatable Read` | é¿å…å¹¶å‘è¯»å†™é—®é¢˜ï¼Œç¡®ä¿æ ¸å¿ƒæ•°æ®å®‰å…¨ |


> **ä¸æ˜¯é¿å…ä½¿ç”¨è¿™å››ç§éš”ç¦»çº§åˆ«ï¼Œè€Œæ˜¯ä½ å¿…é¡»æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦ï¼Œé€‰ä¸€ä¸ªç”¨ã€‚**


ACID æ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››å¤§åŸºæœ¬ç‰¹æ€§ï¼Œè€Œ**éš”ç¦»çº§åˆ«æ˜¯ä¸ºäº†å®ç° ACID ä¸­çš„ Iï¼ˆéš”ç¦»æ€§ï¼‰**è€Œå­˜åœ¨çš„æœºåˆ¶ã€‚


`store.go`

æ‰§è¡Œäº‹åŠ¡

`store_test.go`

```go
package db

  

import (

Â  Â  "context"

Â  Â  "fmt"

Â  Â  "testing"

  

Â  Â  "github.com/stretchr/testify/require"

)

  

func TestTransferTx(t *testing.T) {

Â  Â  account1 := createRandomAccount(t)

Â  Â  account2 := createRandomAccount(t)

Â  Â  fmt.Println(">> before:", account1.Balance, account2.Balance)

  

Â  Â  n := 5

Â  Â  amount := int64(10)

  

Â  Â  errs := make(chan error)

Â  Â  results := make(chan TransferTxResult)

  

Â  Â  // run n concurrent transfer transaction

Â  Â  for i := 0; i < n; i++ {

Â  Â  Â  Â  txName := fmt.Sprintf("tx %d", i+1)

Â  Â  Â  Â  go func(i int) {

Â  Â  Â  Â  Â  Â  ctx := context.WithValue(context.Background(), txKey, txName)

Â  Â  Â  Â  Â  Â  result, err := testStore.TransferTx(ctx, TransferTxParams{

Â  Â  Â  Â  Â  Â  Â  Â  FromAccountID: account1.ID,

Â  Â  Â  Â  Â  Â  Â  Â  ToAccountID: Â  account2.ID,

Â  Â  Â  Â  Â  Â  Â  Â  Amount: Â  Â  Â  Â amount,

Â  Â  Â  Â  Â  Â  })

Â  Â  Â  Â  Â  Â  errs <- err

Â  Â  Â  Â  Â  Â  results <- result

Â  Â  Â  Â  }(i)

Â  Â  }

  

Â  Â  // check results

Â  Â  existed := make(map[int]bool)

  

Â  Â  for i := 0; i < n; i++ {

Â  Â  Â  Â  err := <-errs

Â  Â  Â  Â  require.NoError(t, err)

  

Â  Â  Â  Â  result := <-results

Â  Â  Â  Â  require.NotEmpty(t, result)

  

Â  Â  Â  Â  // check transfer

Â  Â  Â  Â  transfer := result.Transfer

Â  Â  Â  Â  require.NotEmpty(t, transfer)

Â  Â  Â  Â  require.Equal(t, account1.ID, transfer.FromAccountID)

Â  Â  Â  Â  require.Equal(t, account2.ID, transfer.ToAccountID)

Â  Â  Â  Â  require.Equal(t, amount, transfer.Amount)

Â  Â  Â  Â  require.NotZero(t, transfer.ID)

Â  Â  Â  Â  require.NotZero(t, transfer.CreatedAt)

  

Â  Â  Â  Â  _, err = testStore.GetTransfer(context.Background(), transfer.ID)

Â  Â  Â  Â  require.NoError(t, err)

  

Â  Â  Â  Â  // check entries

Â  Â  Â  Â  fromEntry := result.FromEntry

Â  Â  Â  Â  require.NotEmpty(t, fromEntry)

Â  Â  Â  Â  require.Equal(t, account1.ID, fromEntry.AccountID)

Â  Â  Â  Â  require.Equal(t, -amount, fromEntry.Amount)

Â  Â  Â  Â  require.NotZero(t, fromEntry.ID)

Â  Â  Â  Â  require.NotZero(t, fromEntry.CreatedAt)

  

Â  Â  Â  Â  _, err = testStore.GetEntry(context.Background(), fromEntry.ID)

Â  Â  Â  Â  require.NoError(t, err)

  

Â  Â  Â  Â  toEntry := result.ToEntry

Â  Â  Â  Â  require.NotEmpty(t, toEntry)

Â  Â  Â  Â  require.Equal(t, account2.ID, toEntry.AccountID)

Â  Â  Â  Â  require.Equal(t, amount, toEntry.Amount)

Â  Â  Â  Â  require.NotZero(t, toEntry.ID)

Â  Â  Â  Â  require.NotZero(t, toEntry.CreatedAt)

  

Â  Â  Â  Â  _, err = testStore.GetEntry(context.Background(), toEntry.ID)

Â  Â  Â  Â  require.NoError(t, err)

  

Â  Â  Â  Â  // check accounts

Â  Â  Â  Â  fromAccount := result.FromAccount

Â  Â  Â  Â  require.NotEmpty(t, fromAccount)

Â  Â  Â  Â  require.Equal(t, account1.ID, fromAccount.ID)

  

Â  Â  Â  Â  toAccount := result.ToAccount

Â  Â  Â  Â  require.NotEmpty(t, toAccount)

Â  Â  Â  Â  require.Equal(t, account2.ID, toAccount.ID)

  

Â  Â  Â  Â  // check balances

Â  Â  Â  Â  fmt.Println(">> tx:", fromAccount.Balance, toAccount.Balance)

  

Â  Â  Â  Â  diff1 := account1.Balance - fromAccount.Balance

Â  Â  Â  Â  diff2 := toAccount.Balance - account2.Balance

Â  Â  Â  Â  require.Equal(t, diff1, diff2)

Â  Â  Â  Â  require.True(t, diff1 > 0)

Â  Â  Â  Â  require.True(t, diff1%amount == 0) // 1 * amount, 2 * amount, 3 * amount, ..., n * amount

  

Â  Â  Â  Â  k := int(diff1 / amount)

Â  Â  Â  Â  require.True(t, k >= 1 && k <= n)

Â  Â  Â  Â  require.NotContains(t, existed, k)

Â  Â  Â  Â  existed[k] = true

Â  Â  }

  

Â  Â  // check the final updated balance

Â  Â  updatedAccount1, err := testStore.GetAccount(context.Background(), account1.ID)

Â  Â  require.NoError(t, err)

  

Â  Â  updatedAccount2, err := testStore.GetAccount(context.Background(), account2.ID)

Â  Â  require.NoError(t, err)

  

Â  Â  fmt.Println(">> after:", updatedAccount1.Balance, updatedAccount2.Balance)

  

Â  Â  require.Equal(t, account1.Balance-int64(n)*amount, updatedAccount1.Balance)

Â  Â  require.Equal(t, account2.Balance+int64(n)*amount, updatedAccount2.Balance)

}
```


### æ­»é”é¿å…



